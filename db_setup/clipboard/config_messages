
DO
$do$
DECLARE
  f_schema text;
BEGIN
FOR f_schema IN
    SELECT quote_ident(nspname)
    FROM   pg_namespace n
    WHERE  nspname !~~ 'pg_%'
    AND    nspname <> 'information_schema'
    AND    nspname <> 'xdb'
    AND    nspname <> 'c'
    AND    nspname <> 'e'
    AND    nspname <> 'migration'
    AND    nspname <> 'public'
LOOP
   EXECUTE 'SET LOCAL search_path = ' || f_schema;


     INSERT INTO config (id) SELECT 'messages'
          WHERE NOT EXISTS (SELECT 't'::boolean from config where id = 'messages');

     UPDATE config SET data = jsonb_set(data, '{categories}', '{}'::jsonb)
          where id = 'messages';

     UPDATE config SET data = jsonb_set(data, '{cleanup}', '{}'::jsonb)
          where id = 'messages';

     UPDATE config SET data = jsonb_set(data, '{cleanup, enabled}', 'true'::jsonb)
          where id = 'messages';

     UPDATE config SET data = jsonb_set(data, '{cleanup, after_days}', (select data->>'value'
          from xdb.aggs
          where agg_type = 'setting'
               and agg_schema = f_schema
               and eland_id = 'msgexpcleanupdays')::jsonb)
          where id = 'messages';


END LOOP;
END
$do$
;
