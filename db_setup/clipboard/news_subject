news_subject
-------------


DO
$do$
DECLARE
  f_schema text;
BEGIN

FOR f_schema IN
    SELECT quote_ident(nspname)
    FROM   pg_namespace n
    WHERE  nspname !~~ 'pg_%'
    AND    nspname <>  'information_schema'
    AND    nspname <> 'xdb'
    AND    nspname <> 'c'
    AND    nspname <> 'e'
    AND    nspname <> 'migration'
    AND    nspname <> 'public'
LOOP
   EXECUTE 'SET LOCAL search_path = ' || f_schema;

    DROP TRIGGER IF EXISTS trig_set_approved_at ON news;

    ALTER TABLE news
        DROP COLUMN IF EXISTS event_at,
        DROP COLUMN IF EXISTS approved_at,
        DROP COLUMN IF EXISTS approved_by,
        DROP COLUMN IF EXISTS is_sticky,
        DROP COLUMN IF EXISTS is_approved;

   ALTER TABLE news
        ADD COLUMN IF NOT EXISTS event_at timestamp without time zone,
        ADD COLUMN IF NOT EXISTS is_sticky bool not null default 'f'::bool,
        ADD COLUMN IF NOT EXISTS is_approved bool not null default 'f'::bool,
        ALTER COLUMN location TYPE text,
        ALTER COLUMN access SET DEFAULT 'admin'::text,
        ALTER COLUMN access SET NOT NULL;

    UPDATE news SET event_at = itemdate;
    UPDATE news SET is_approved = approved;
    UPDATE news SET is_sticky = sticky where sticky IS NOT NULL;

END LOOP;

END
$do$



-----


DO
$do$
DECLARE
  f_schema text;
BEGIN

FOR f_schema IN
    SELECT quote_ident(nspname)
    FROM   pg_namespace n
    WHERE  nspname !~~ 'pg_%'
    AND    nspname <>  'information_schema'
    AND    nspname <> 'xdb'
    AND    nspname <> 'c'
    AND    nspname <> 'e'
    AND    nspname <> 'migration'
    AND    nspname <> 'public'
LOOP
   EXECUTE 'SET LOCAL search_path = ' || f_schema;
   ALTER TABLE news
        DROP COLUMN IF EXISTS itemdate,
        DROP COLUMN IF EXISTS approved,
        DROP COLUMN IF EXISTS sticky;

END LOOP;

END
$do$

-----



DO
$do$
DECLARE
  f_schema text;
BEGIN

FOR f_schema IN
    SELECT quote_ident(nspname)
    FROM   pg_namespace n
    WHERE  nspname !~~ 'pg_%'
    AND    nspname <>  'information_schema'
    AND    nspname <> 'xdb'
    AND    nspname <> 'c'
    AND    nspname <> 'e'
    AND    nspname <> 'migration'
    AND    nspname <> 'public'
LOOP
   EXECUTE 'SET LOCAL search_path = ' || f_schema;

   DELETE FROM news WHERE is_approved = 'f';

   ALTER TABLE news
        DROP COLUMN IF EXISTS is_approved,
        DROP COLUMN IF EXISTS is_sticky;

END LOOP;

END
$do$