calendar
--------

DO
$do$
DECLARE
  f_schema text;
BEGIN

FOR f_schema IN
    SELECT quote_ident(nspname)
    FROM   pg_namespace n
    WHERE  nspname !~~ 'pg_%'
    AND    nspname <>  'information_schema'
    AND    nspname <> 'xdb'
    AND    nspname <> 'c'
    AND    nspname <> 'e'
    AND    nspname <> 'migration'
    AND    nspname <> 'public'
LOOP
   EXECUTE 'SET LOCAL search_path = ' || f_schema;

   DROP TRIGGER IF EXISTS trig_set_last_edit_at on calendar_items;
   DROP TRIGGER IF EXISTS trig_set_last_edit_at on calendar_items_periods;

     create table if not exists calendar_items (
          id serial primary key,
          subject text not null,
          location text,
          content text not null default ''::text,
          access text not null default 'admin'::text,
          created_by int not null,
          created_at timestamp without time zone not null default timezone('utc'::text, now()),
          last_edit_at timestamp without time zone not null default timezone('utc'::text, now()),
          edit_count int not null default 0);

     create table if not exists calendar_items_periods (
          id serial primary key,
          calendar_item_id int not null,
          start_at timestamp without time zone not null,
          end_at timestamp without time zone not null,
          created_at timestamp without time zone not null default timezone('utc'::text, now()),
          last_edit_at timestamp without time zone not null default timezone('utc'::text, now()),
          edit_count int not null default 0);

     CREATE TRIGGER trig_set_last_edit_at
     BEFORE UPDATE ON calendar_items
     FOR EACH ROW
     EXECUTE PROCEDURE set_last_edit_at();

     CREATE TRIGGER trig_set_last_edit_at
     BEFORE UPDATE ON calendar_items_periods
     FOR EACH ROW
     EXECUTE PROCEDURE set_last_edit_at();

END LOOP;

END
$do$



-----


DO
$do$
DECLARE
  f_schema text;
BEGIN

FOR f_schema IN
    SELECT quote_ident(nspname)
    FROM   pg_namespace n
    WHERE  nspname !~~ 'pg_%'
    AND    nspname <>  'information_schema'
    AND    nspname <> 'xdb'
    AND    nspname <> 'c'
    AND    nspname <> 'e'
    AND    nspname <> 'migration'
    AND    nspname <> 'public'
LOOP
   EXECUTE 'SET LOCAL search_path = ' || f_schema;

END LOOP;

END
$do$
